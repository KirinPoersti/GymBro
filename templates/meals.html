{% extends "base.html" %}
{% block wrap_class %}wrap--wide{% endblock %}
{% block header %}{% endblock %}
{% block content %}

<div class="topbar">
  <div class="brand">GymBro</div>
</div>

<div class="train-wrap">
  <h2 class="train-title">{{ d }} – Meals</h2>

  <div id="meal-list" class="stack"></div>

  <div class="actions-row">
    <button class="btn" id="add-meal">+ Add meal</button>
    <button class="btn" id="save">Save</button>
  </div>
</div>

<style>
  .train-wrap{
    width:560px;
    margin:0 auto 24px;
    display:flex;
    flex-direction:column;
    gap:16px;
  }
  .train-title{ text-align:center; margin:0 0 6px; }

  .stack{ display:flex; flex-direction:column; gap:16px; }
  .brand {
    font-size: 34px;   
    font-weight: 400;  
    text-decoration: none;
    color: #111;
  }

  .meal-card{
    width:100%;
    border:1.5px solid #222; border-radius:16px; background:#fff;
    padding:16px; position:relative; margin:0;
  }
  .actions-row{ display:flex; justify-content:center; gap:12px; margin-top:6px; }

  .kill-meal{
    position:absolute; top:10px; right:10px;
    width:30px; height:30px; border:1.5px solid #222; border-radius:8px;
    display:flex; align-items:center; justify-content:center;
    background:#fff; font-weight:700; cursor:pointer;
  }

  .meal-body{ display:flex; flex-direction:column; align-items:center; gap:8px; }

  .meal-name-pill{
    display:inline-flex; align-items:center; justify-content:center;
    border:1.5px solid #222; border-radius:18px; background:#fff;
    height:36px; width:auto; padding-top:8.5px;
  }
  .meal-name-input{
    border:0; outline:none; background:transparent;
    font-size:16px; text-align:center;
    width:auto; height:36px; line-height:36px;
  }

  /* food item pill */
  .food-name-wrap{ display:flex; justify-content:center; margin-bottom:8px; }
  .food-name-pill{
    display:inline-flex; align-items:center; justify-content:center;
    border:1.5px solid #222; border-radius:18px; background:#fff;
    height:36px; width:auto; padding-top:8.5px;
  }
  .food-name-input{
    border:0; outline:none; background:transparent;
    font-size:16px; text-align:center;
    width:auto; height:36px; line-height:36px;
  }

  .item-panel{
    border:1.5px solid #222; border-radius:16px; background:#fff;
    padding:18px; margin-top:12px; position:relative;
  }
  .kill-item{
    position:absolute; top:10px; right:10px;
    width:28px; height:28px; border:1.5px solid #222; border-radius:8px;
    display:flex; align-items:center; justify-content:center;
    background:#fff; cursor:pointer; font-weight:700;
  }

  .macro-grid{ display:flex; gap:32px; justify-content:center; }

  .big-square{
    width:60px; height:60px;
    border:1.5px solid #222; border-radius:10px;
    display:flex; align-items:center; justify-content:center; background:#fff;
  }
  .big-input{
    width:100%; height:100%;
    border:0; outline:none;
    text-align:center; font-size:18px; line-height:1;
    margin:0; padding:0; background:transparent;
  }
  .big-label{ text-align:center; margin-top:4px; font-size:13px; }

  .add-item-bottom{
    width:60px; height:60px;
    border:1.5px solid #222; border-radius:10px;
    display:flex; align-items:center; justify-content:center;
    background:#fff; cursor:pointer; font-weight:700; font-size:20px;
    align-self:center; margin:0;           
  }
</style>

<script>
  const initial = {{ meals|tojson }};
  const list = document.getElementById('meal-list');

  function sizePill(input){
    const min = 120, max = 420;
    const text = input.value || input.placeholder || '';
    const w = Math.max(min, Math.min(max, 22 + text.length * 9));
    input.closest('div').style.width = w + 'px';
  }
  function wirePillAutosize(input){
    sizePill(input);
    input.addEventListener('input', () => sizePill(input));
  }

  function render(){
    list.innerHTML = '';

    state.meals.forEach((meal, idx) => {
      const card = document.createElement('div');
      card.className = 'meal-card';
      card.innerHTML = `
        <button class="kill-meal" data-del="${idx}">x</button>

        <div class="meal-body">
          <div class="meal-name-pill">
            <input class="meal-name-input" placeholder="Meal name (e.g., Breakfast)" value="${meal.name || ''}">
          </div>

          <div class="item-list" id="items-${idx}"></div>

          <button class="add-item-bottom" data-additem="${idx}">+</button>
        </div>
      `;
      list.appendChild(card);

      const nameInput = card.querySelector('.meal-name-input');
      nameInput.oninput = e => { meal.name = e.target.value; sizePill(nameInput); };
      wirePillAutosize(nameInput);

      card.querySelector('.kill-meal').onclick = () => { state.meals.splice(idx, 1); render(); };

      const itemsEl = card.querySelector('#items-' + idx);
      meal.items.forEach((it, j) => {
        const panel = document.createElement('div');
        panel.className = 'item-panel';
        panel.innerHTML = `
          <button class="kill-item" data-delitem="${idx}-${j}">x</button>
          <div class="food-name-wrap">
            <div class="food-name-pill">
              <input class="food-name-input" placeholder="Food item" value="${it.name || ''}">
            </div>
          </div>
          <div class="macro-grid">
            <div>
              <div class="big-square"><input class="big-input p" type="number" min="0" step="0.1" value="${it.protein ?? ''}"></div>
              <div class="big-label">Protein(g)</div>
            </div>
            <div>
              <div class="big-square"><input class="big-input c" type="number" min="0" step="0.1" value="${it.carbs ?? ''}"></div>
              <div class="big-label">Carb(g)</div>
            </div>
            <div>
              <div class="big-square"><input class="big-input k" type="number" min="0" step="1" value="${it.calories ?? ''}"></div>
              <div class="big-label">Calories</div>
            </div>
          </div>
        `;
        itemsEl.appendChild(panel);

        const foodInput = panel.querySelector('.food-name-input');
        foodInput.oninput = e => { it.name = e.target.value; sizePill(foodInput); };
        wirePillAutosize(foodInput);

        const pI = panel.querySelector('.p');
        const cI = panel.querySelector('.c');
        const kI = panel.querySelector('.k');
        pI.oninput = e => it.protein  = e.target.value;
        cI.oninput = e => it.carbs    = e.target.value;
        kI.oninput = e => it.calories = e.target.value;

        panel.querySelector('[data-delitem]').onclick = () => { meal.items.splice(j, 1); render(); };
      });

      card.querySelector('[data-additem]').onclick = () => { meal.items.push({ name:'', protein:'', carbs:'', calories:'' }); render(); };
    });
  }

  const state = { meals: (initial && initial.length ? initial : [{ name:'', items:[] }]) };
  render();

  document.getElementById('add-meal').onclick = () => { state.meals.push({ name:'', items:[] }); render(); };

  document.getElementById('save').onclick = async () => {
    const payload = {
      meals: state.meals
        .filter(m => (m.name || '').trim() || m.items.length)
        .map(m => ({
          name: (m.name || '').trim(),
          items: m.items
            .filter(it => (it.protein !== '' || it.carbs !== '' || it.calories !== '' || (it.name||'').trim()))
            .map(it => ({ name: (it.name||'').trim(), protein: it.protein, carbs: it.carbs, calories: it.calories }))
        }))
    };
    const r = await fetch(location.pathname, {
      method:'POST',
      headers:{ 'Content-Type':'application/json' },
      body: JSON.stringify(payload)
    });
    alert(r.ok ? 'Saved ✅' : 'Save failed');
  };
</script>

{% endblock %}
