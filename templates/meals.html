{% extends "base.html" %}
{% block wrap_class %}wrap--wide{% endblock %}
{% block header %}{% endblock %}
{% block content %}

<div class="topbar">
</div>

<div class="train-wrap">
  <h2 class="train-title">
    {{ d }} – Meals
    {% if is_lowcarb %}
      <span class="badge low">Low-carb day · target {{ suggested_carbs or '—' }} g</span>
    {% elif is_highcarb %}
      <span class="badge high">High-carb day · target {{ suggested_carbs or '—' }} g</span>
    {% else %}
      <span class="badge neutral">Regular · target {{ suggested_carbs or '—' }} g</span>
    {% endif %}
  </h2>

  <div id="meal-list" class="stack"></div>

  <div class="actions-row">
    <button class="btn" id="add-meal" type="button">+ Add meal</button>
    <button class="btn" id="save" type="button">Save</button>
  </div>
</div>

<style>
  .badge{
    margin-left:8px;
    padding:4px 10px;
    border:none;
    border-radius:12px;
    font-size:13px;
    color:#111;
    background:#eee;
    box-shadow:
      0 1px 2px rgba(0,0,0,.08),
      0 6px 18px rgba(0,0,0,.10);
  }
  .badge.low{ background:#D2DDE9; }
  .badge.high{ background:#A8E4A0; }
  .badge.neutral{ background:#eee; }

  .train-wrap{
    width:560px;
    margin:0 auto 24px;
    display:flex;
    flex-direction:column;
    gap:16px;
  }
  .train-title{ text-align:center; margin:0 0 6px; }
  .stack{ display:flex; flex-direction:column; gap:16px; }
  .brand{ font-size:34px; text-decoration:none; color:#111; }

  .meal-card{
    width:100%;
    border:none;
    border-radius:16px;
    background:#fff;
    padding:16px;
    position:relative;
    margin:0;
    box-shadow:
      0 1px 2px rgba(0,0,0,.08),
      0 8px 24px rgba(0,0,0,.10);
    transition: box-shadow .2s ease, transform .2s ease, background .2s ease;
  }
  .meal-card:hover{
    transform: translateY(-1px);
    background:#fff;
    box-shadow:
      0 2px 6px rgba(0,0,0,.10),
      0 14px 32px rgba(0,0,0,.16);
  }

  .kill-btn{
    position:absolute;
    top:10px;
    right:10px;
    width:30px;
    height:30px;
    border:none;
    border-radius:10px;
    display:flex;
    align-items:center;
    justify-content:center;
    background:#fff;
    cursor:pointer;
    box-shadow:
      0 1px 2px rgba(0,0,0,.08),
      0 8px 20px rgba(0,0,0,.10);
    transition: box-shadow .2s ease, transform .2s ease, background .2s ease;
  }
  .kill-btn.small{ width:28px; height:28px; }
  .kill-btn:hover{
    transform: translateY(-1px);
    background:#f7f7f7;
    box-shadow:
      0 2px 6px rgba(0,0,0,.10),
      0 14px 28px rgba(0,0,0,.16);
  }
  .kill-btn:focus-visible{ outline:none; box-shadow: inset 0 0 0 3px rgba(122,167,255,1); }

  .meal-body{ display:flex; flex-direction:column; align-items:center; gap:8px; }

  .meal-name-pill,
  .food-name-pill{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    border:none;
    border-radius:18px;
    background:#fff;
    padding:0 12px;
    height:36px;
    min-width:200px;
    box-shadow:none;
  }
  .meal-name-input,
  .food-name-input{
    border:0;
    outline:none;
    background:transparent;
    font-size:16px;
    text-align:center;
    min-width:200px;
    width:auto;
    height:36px;
    line-height:36px;
  }

  .food-name-wrap{ display:flex; justify-content:center; margin-bottom:8px; }

  .item-panel{
    border:none;
    border-radius:16px;
    background:#fff;
    padding:18px;
    margin-top:12px;
    position:relative;
    box-shadow:
      0 1px 2px rgba(0,0,0,.08),
      0 8px 24px rgba(0,0,0,.10);
    transition: box-shadow .2s ease, transform .2s ease;
  }
  .item-panel:hover{
    transform: translateY(-1px);
    box-shadow:
      0 2px 6px rgba(0,0,0,.10),
      0 14px 32px rgba(0,0,0,.16);
  }

  .macro-grid{ display:flex; gap:32px; justify-content:center; }

  .big-square{
    width:60px;
    height:60px;
    border:none;
    border-radius:10px;
    background:#fff;
    display:flex;
    align-items:center;
    justify-content:center;
    box-shadow:
      0 1px 2px rgba(0,0,0,.08),
      0 8px 20px rgba(0,0,0,.08);
    transition: box-shadow .2s ease, transform .2s ease, background .2s ease;
  }
  .big-input{
    width:100%;
    height:100%;
    border:0;
    outline:none;
    background:transparent;
    text-align:center;
    font-size:18px;
    line-height:1;
    margin:0;
    padding:0;
  }
  .big-input:focus{
    box-shadow: inset 0 0 0 3px rgba(122,167,255,1);
    border-radius:10px;
  }
  .big-label{ text-align:center; margin-top:4px; font-size:13px; }

  .add-item-bottom{
    width:60px;
    height:60px;
    border:none;
    border-radius:10px;
    display:flex;
    align-items:center;
    justify-content:center;
    background:#fff;
    cursor:pointer;
    font-size:20px;
    align-self:center;
    margin:0;
    box-shadow:
      0 1px 2px rgba(0,0,0,.08),
      0 8px 20px rgba(0,0,0,.10);
    transition: box-shadow .2s ease, transform .2s ease, background .2s ease;
  }
  .add-item-bottom:hover{
    transform: translateY(-1px);
    background:#f7f7f7;
    box-shadow:
      0 2px 6px rgba(0,0,0,.10),
      0 14px 28px rgba(0,0,0,.16);
  }

  .actions-row{ display:flex; justify-content:center; gap:12px; margin-top:6px; }
</style>

<script>
  'use strict';

  const initial = {{ meals|tojson }};
  const list = document.getElementById('meal-list');

  function sizePill(input){
    const min = 120, max = 420;
    const text = input.value || input.placeholder || '';
    const w = Math.max(min, Math.min(max, 22 + text.length * 9));
    const pill = input.closest('.meal-name-pill, .food-name-pill');
    if (pill) pill.style.width = w + 'px';
  }
  function wirePillAutosize(input){
    sizePill(input);
    input.addEventListener('input', () => sizePill(input));
  }

  function render(){
    list.innerHTML = '';

    state.meals.forEach((meal, idx) => {
      const card = document.createElement('div');
      card.className = 'meal-card';
      card.innerHTML = `
        <button class="kill-btn" type="button" data-del="${idx}" aria-label="Delete meal">x</button>
        <div class="meal-body">
          <div class="meal-name-pill">
            <input class="meal-name-input" placeholder="Meal name" value="${meal.name || ''}">
          </div>
          <div class="item-list" id="items-${idx}"></div>
          <button class="add-item-bottom" type="button" data-additem="${idx}" aria-label="Add item">+</button>
        </div>
      `;
      list.appendChild(card);

      const nameInput = card.querySelector('.meal-name-input');
      nameInput.oninput = e => { meal.name = e.target.value; sizePill(nameInput); };
      wirePillAutosize(nameInput);

      card.querySelector('[data-del]').onclick = () => { state.meals.splice(idx, 1); render(); };

      const itemsEl = card.querySelector('#items-' + idx);
      meal.items.forEach((it, j) => {
        const panel = document.createElement('div');
        panel.className = 'item-panel';
        panel.innerHTML = `
          <button class="kill-btn small" type="button" data-delitem="${idx}-${j}" aria-label="Remove item">x</button>
          <div class="food-name-wrap">
            <div class="food-name-pill">
              <input class="food-name-input" placeholder="Food item" value="${it.name || ''}">
            </div>
          </div>
          <div class="macro-grid">
            <div>
              <div class="big-square"><input class="big-input p" type="number" min="0" step="0.1" value="${it.protein ?? ''}"></div>
              <div class="big-label">Protein(g)</div>
            </div>
            <div>
              <div class="big-square"><input class="big-input c" type="number" min="0" step="0.1" value="${it.carbs ?? ''}"></div>
              <div class="big-label">Carb(g)</div>
            </div>
            <div>
              <div class="big-square"><input class="big-input k" type="number" min="0" step="1" value="${it.calories ?? ''}"></div>
              <div class="big-label">Calories</div>
            </div>
          </div>
        `;
        itemsEl.appendChild(panel);

        const foodInput = panel.querySelector('.food-name-input');
        foodInput.oninput = e => { it.name = e.target.value; sizePill(foodInput); };
        wirePillAutosize(foodInput);

        const pI = panel.querySelector('.p');
        const cI = panel.querySelector('.c');
        const kI = panel.querySelector('.k');
        pI.oninput = e => it.protein  = e.target.value;
        cI.oninput = e => it.carbs    = e.target.value;
        kI.oninput = e => it.calories = e.target.value;

        panel.querySelector('[data-delitem]').onclick = () => { meal.items.splice(j, 1); render(); };
      });

      card.querySelector('[data-additem]').onclick = () => {
        meal.items.push({ name:'', protein:'', carbs:'', calories:'' });
        render();
      };
    });
  }

  const state = { meals: (initial && initial.length ? initial : [{ name:'', items:[] }]) };
  render();

  document.getElementById('add-meal').onclick = () => {
    state.meals.push({ name:'', items:[] });
    render();
  };

  document.getElementById('save').onclick = async () => {
    const payload = {
      meals: state.meals
        .filter(m => (m.name || '').trim() || m.items.length)
        .map(m => ({
          name: (m.name || '').trim(),
          items: m.items
            .filter(it =>
              it.protein !== '' || it.carbs !== '' || it.calories !== '' || (it.name || '').trim()
            )
            .map(it => ({
              name: (it.name || '').trim(),
              protein: it.protein,
              carbs: it.carbs,
              calories: it.calories
            }))
        }))
    };

    const r = await fetch(location.pathname, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    alert(r.ok ? 'Saved ✅' : 'Save failed');
  };
</script>

{% endblock %}
