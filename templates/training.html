{% extends "base.html" %}
{% block wrap_class %}wrap--wide{% endblock %}
{% block header %}{% endblock %}
{% block content %}

<div class="topbar">
  <div class="brand">GymBro</div>
</div>

<div class="train-wrap">
  <h2 class="train-title">{{ d }} – Training</h2>

  <div id="ex-list" class="stack"></div>

  <div class="actions-row">
    <button class="btn" id="add-ex">+ Add exercise</button>
    <button class="btn" id="save">Save</button>
  </div>
</div>

<style>
  .train-wrap{
    width:560px;
    margin:0 auto 24px;
    display:flex;
    flex-direction:column;
    gap:16px;
  }
  .train-title{ text-align:center; margin:0 0 6px; }

  .stack{ display:flex; flex-direction:column; gap:16px; }
  .brand {
    font-size: 34px;   
    font-weight: 400;  
    text-decoration: none;
    color: #111;
  }
  .ex-card{
    width:100%;
    border:1.5px solid #222; border-radius:16px; background:#fff;
    padding:16px; position:relative; margin:0;
  }

  .actions-row{
    display:flex; justify-content:center; gap:12px; margin-top:6px;
  }

  .kill-ex{
    position:absolute; top:10px; right:10px;
    width:30px; height:30px; border:1.5px solid #222; border-radius:8px;
    display:flex; align-items:center; justify-content:center;
    background:#fff; font-weight:700; cursor:pointer;
  }

  .ex-body{
    display:flex; flex-direction:column; align-items:center; gap:5px;
  }
  .set-list{ width:100%; }

  .ex-name-wrap{ display:flex; justify-content:center; }
  .ex-name-pill{
    display:inline-flex; align-items:center; justify-content:center;
    border:1.5px solid #222; border-radius:18px; background:#fff;
    height:36px; padding-top:8.5px; width:auto;
  }
  .ex-name-input{
    border:0; outline:none; background:transparent;
    font-size:16px; text-align:center;
    width:auto; height:36px; line-height:36px;
  }

  .set-panel{
    border:1.5px solid #222; border-radius:16px; background:#fff;
    padding:18px; margin-top:12px; position:relative;
  }
  .set-title{ text-align:center; font-weight:700; margin-bottom:16px; }
  .kill-set{
    position:absolute; top:10px; right:10px;
    width:28px; height:28px; border:1.5px solid #222; border-radius:8px;
    display:flex; align-items:center; justify-content:center;
    background:#fff; cursor:pointer; font-weight:700;
  }

  .set-grid{ display:flex; gap:32px; justify-content:center; }

  .big-square{
    width:60px; height:60px;
    border:1.5px solid #222; border-radius:10px;
    display:flex; align-items:center; justify-content:center; background:#fff;
  }
  .big-input{
    width:100%; height:100%;
    border:0; outline:none;
    text-align:center; font-size:18px; line-height:1;
    margin:0; padding:0; background:transparent;
  }
  .big-label{ text-align:center; margin-top:4px; font-size:13px; }

  .add-set-bottom{
    width:60px; height:60px;
    border:1.5px solid #222; border-radius:10px;
    display:flex; align-items:center; justify-content:center;
    background:#fff; cursor:pointer; font-weight:700; font-size:20px;
    align-self:center;  
    margin:0;           
  }

  input[type=number]::-webkit-inner-spin-button,
  input[type=number]::-webkit-outer-spin-button{ -webkit-appearance:none; margin:0; }
  input[type=number]{ -moz-appearance:textfield; }

  @media (max-width:640px){
    .train-wrap{ width:100%; max-width:560px; padding:0 12px; }
  }
</style>

<script>
  const initial = {{ exercises|tojson }};
  const list = document.getElementById('ex-list');

  function sizePill(input){
    const min = 80, max = 420;
    const text = input.value || input.placeholder || '';
    const w = Math.max(min, Math.min(max, 22 + text.length * 9));
    input.closest('.ex-name-pill').style.width = w + 'px';
  }
  function wirePillAutosize(input){
    sizePill(input);
    input.addEventListener('input', () => sizePill(input));
  }

  function render(){
    list.innerHTML = '';

    state.exercises.forEach((ex, idx) => {
      const card = document.createElement('div');
      card.className = 'ex-card';
      card.innerHTML = `
        <button class="kill-ex" data-del="${idx}">x</button>

        <div class="ex-body">
          <div class="ex-name-wrap">
            <div class="ex-name-pill">
              <input class="ex-name-input" placeholder="Exercise" value="${ex.name || ''}">
            </div>
          </div>

          <div class="set-list" id="sets-${idx}"></div>

          <button class="add-set-bottom" data-addset="${idx}">+</button>
        </div>
      `;
      list.appendChild(card);


      const nameInput = card.querySelector('.ex-name-input');
      nameInput.oninput = e => { ex.name = e.target.value; sizePill(nameInput); };
      wirePillAutosize(nameInput);

      card.querySelector('.kill-ex').onclick = () => { state.exercises.splice(idx, 1); render(); };

      const setsEl = card.querySelector('#sets-' + idx);
      ex.sets.forEach((s, sidx) => {
        const panel = document.createElement('div');
        panel.className = 'set-panel';
        panel.innerHTML = `
          <button class="kill-set" data-delset="${idx}-${sidx}">x</button>
          <div class="set-title">Set ${sidx + 1}</div>
          <div class="set-grid">
            <div>
              <div class="big-square"><input class="big-input" type="number" min="0" step="0.5" value="${s.weight ?? ''}"></div>
              <div class="big-label">kg</div>
            </div>
            <div>
              <div class="big-square"><input class="big-input" type="number" min="0" step="1" value="${s.reps ?? ''}"></div>
              <div class="big-label">reps</div>
            </div>
          </div>
        `;
        setsEl.appendChild(panel);

        const [wI, rI] = panel.querySelectorAll('.big-input');
        wI.oninput = e => s.weight = e.target.value;
        rI.oninput = e => s.reps   = e.target.value;
        panel.querySelector('[data-delset]').onclick = () => { ex.sets.splice(sidx, 1); render(); };
      });

      card.querySelector('[data-addset]').onclick = () => { ex.sets.push({ weight:'', reps:'' }); render(); };
    });
  }

  const state = { exercises: (initial && initial.length ? initial : [{ name:'', sets:[] }]) };
  render();

  document.getElementById('add-ex').onclick = () => { state.exercises.push({ name:'', sets:[] }); render(); };

  document.getElementById('save').onclick = async () => {
    const payload = {
      exercises: state.exercises
        .filter(e => (e.name || '').trim() || e.sets.length)
        .map(e => ({
          name: (e.name || '').trim(),
          sets: e.sets.filter(s => (s.reps !== '' || s.weight !== '')),
        }))
    };
    const r = await fetch(location.pathname, {
      method:'POST',
      headers:{ 'Content-Type':'application/json' },
      body: JSON.stringify(payload)
    });
    alert(r.ok ? 'Saved ✅' : 'Save failed');
  };
</script>

{% endblock %}
