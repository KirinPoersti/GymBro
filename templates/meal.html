{% extends "base.html" %}
{% block wrap_class %}wrap--wide{% endblock %}
{% block header %}{% endblock %}
{% block content %}
<div class="topbar"><div class="brand">GymBro</div></div>
<h2 style="text-align:center;margin-bottom:10px;">{{ d }} – Meals</h2>

<div id="meal-list" class="stack"></div>
<button class="btn" id="add-meal">+ Add meal</button>
<button class="btn" id="save" style="margin-top:10px;">Save</button>

<style>
.stack{display:flex;flex-direction:column;gap:14px;margin-bottom:10px;}
.meal{border:1.5px solid #222;border-radius:14px;padding:14px;background:#fff;}
.meal-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;}
.meal label{font-weight:600;margin-right:8px}
.items{display:flex;gap:10px;flex-wrap:wrap;}
.item{border:1.5px solid #222;border-radius:10px;padding:8px}
.item input{width:100px}
.tot{margin-top:8px;color:#444}
.small-btn{padding:4px 8px;border:1.5px solid #222;border-radius:8px;background:#fff;cursor:pointer;}
</style>

<script>
const initial = {{ meals|tojson }};
const list = document.getElementById('meal-list');

function total(m){
  return m.items.reduce((a,it)=>({p:a.p+(+it.protein||0), c:a.c+(+it.carbs||0), k:a.k+(+it.calories||0)}), {p:0,c:0,k:0});
}

function render(){
  list.innerHTML = '';
  state.meals.forEach((m, midx) => {
    const card = document.createElement('div'); card.className='meal';
    const {p,c,k} = total(m);
    card.innerHTML = `
      <div class="meal-head">
        <div>
          <label>Label:</label>
          <input class="label" placeholder="e.g. High Carb / Lunch" value="${m.label||''}" />
        </div>
        <button class="small-btn" data-del="${midx}">x</button>
      </div>
      <div class="items" id="items-${midx}"></div>
      <button class="small-btn" data-add="${midx}">+ item</button>
      <div class="tot">Totals – Protein: ${p.toFixed(1)} g, Carbs: ${c.toFixed(1)} g, Calories: ${k.toFixed(0)}</div>
    `;
    list.appendChild(card);
    const items = card.querySelector('#items-'+midx);
    m.items.forEach((it, iidx) => {
      const box = document.createElement('div'); box.className='item';
      box.innerHTML = `
        <input placeholder="Food" value="${it.food||''}" />
        <input type="number" step="0.1" placeholder="Protein (g)" value="${it.protein??''}" />
        <input type="number" step="0.1" placeholder="Carbs (g)" value="${it.carbs??''}" />
        <input type="number" step="1"   placeholder="Calories" value="${it.calories??''}" />
        <button class="small-btn" data-delitem="${midx}-${iidx}">x</button>
      `;
      items.appendChild(box);
      const [f,p,c,k] = box.querySelectorAll('input');
      f.oninput = e => it.food = e.target.value;
      p.oninput = e => it.protein = e.target.value;
      c.oninput = e => it.carbs = e.target.value;
      k.oninput = e => it.calories = e.target.value;
      box.querySelector('[data-delitem]').onclick = () => { m.items.splice(iidx,1); render(); };
    });
    card.querySelector('.label').oninput = e => { m.label = e.target.value; };
    card.querySelector('[data-add]').onclick = () => { m.items.push({food:'', protein:'', carbs:'', calories:''}); render(); };
    card.querySelector('[data-del]').onclick = () => { state.meals.splice(midx,1); render(); };
  });
}

const state = { meals: (initial && initial.length ? initial : [{label:'', items:[] }]) };
render();

document.getElementById('add-meal').onclick = () => { state.meals.push({label:'', items:[]}); render(); };

document.getElementById('save').onclick = async () => {
  const payload = {
    meals: state.meals
      .filter(m => (m.label||'').trim() || m.items.length)
      .map(m => ({
        label: (m.label||'').trim(),
        items: m.items.filter(i => (i.food||'').trim() || i.protein || i.carbs || i.calories)
      }))
  };
  const r = await fetch(location.pathname, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
  if(r.ok){ alert('Saved ✅'); } else { alert('Save failed'); }
};
</script>
{% endblock %}
